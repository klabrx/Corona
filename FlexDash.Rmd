---
title: "Corona-Dashboard der Stadt Passau"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
params:
  IDKreis: 09262
  NameKreis: "SK Passau"
  EWO: 52803
  backweek: 3
  limits: !r c(35,50,100,150)
  Altersklasse: !r c("A00-A04","A05-A14","A15-A34","A35-A59","A60-A79","A80+")
  EWOAK: !r c(2138,3180,15820,16601,11298,3744)
---

```{r setup, include=FALSE}
library(curl)
library(jsonlite)
library(lubridate)
library(ggplot2)
library(dplyr)
library(tidyr)
library(zoo)
library(openxlsx)
library(svDialogs)
library(ggrepel)
library(flexdashboard)
library(knitr)
library(readxl)
library(rio)
library(stringr)
library(plotly)

# get parameters from YAML header
EWO <- as.numeric(params$EWO)
backweek <- params$backweek
AG <- params$IDKreis
Altersklassen <- data.frame(Altersklasse     = params$Altersklasse,
                            EWO              = params$EWOAK,
                            stringsAsFactors = FALSE)
```

```{r functions, eval=TRUE, echo=FALSE}

# Rekursive Funktion zum Abruf von Corona-Zahlen direkt über die RKI-API:
# Parameter: 
#   Gemeindeschlüssel (z.B. 09262 für Kreisfreie Stadt Passau)
#   Meldedatum von-bis (MD_von, MD_bis)

RKI.cases <- function(AGS, MD_von, MD_bis)
{service.url <- paste0("https://services7.arcgis.com/",
                        "mOBPykOjAyBO2ZKk/",
                        "arcgis/rest/services/RKI_COVID19/FeatureServer/0/",
                        "query?where=")
  parameters <- paste(sep="&",
                      paste(sep=" AND ",
                            paste("IdLandkreis = ",AGS),
                            paste("Meldedatum >= TIMESTAMP '",MD_von," 00:00:00'"),
                            paste("Meldedatum <= TIMESTAMP '",MD_bis," 00:00:00'"),
                            "NeuerFall in (-1,0,1)"
                      ),
                      # "outFields=AnzahlFall,Meldedatum",
                      "outFields=AnzahlFall,Meldedatum,Altersgruppe,Geschlecht,NeuerFall,AnzahlTodesfall,NeuerTodesfall",
                      "orderByFieldsForStatistics=Meldedatum",
                      "groupByFieldsForStatistics=Meldedatum",
                      "f=pjson"
  )
  
  # Zusammenfügen von Link und Parametern, URL-taugliche Codierung
  GET.request <- URLencode(paste0(service.url, parameters))
  
  # Hier erfolgt die eigentliche Abfrage
  RKI_data <- fromJSON(GET.request)
  
  # Umwandlung JSON-Format in Dataframe
  cases <- as.data.frame(RKI_data$features$attributes)
  # Umwandlung JSON-Datumsformat in humanlesbar
  cases$Meldedatum <- as.Date(cases$Meldedatum/86400000,origin="1970-01-01")
  
  
  # Rekursion (Minimiert die Anzahl der API-Abrufe *UND* ist datumsunabhängig):
  # WENN der Abruf weniger als 5000 Zeilen lang ist (Limit der API),
  # DANN ist die Funktion durch, 'cases' wird zurückgegeben.
  # SONST: Der letzte evtl. unvollständige Meldetag ('MD') wird entfernt,
  #        ein erneuter Abruf, diesmal beginnend mit MD erfolgt,
  #        die resultierenden Zeilen werden angefügt, bis endlich ein Abruf
  #        mit weniger als 5000 Zeilen erfolgt (Ausstieg aus der Rekursion)
  MD <- max(cases$Meldedatum)
  if (as.numeric(count(cases)) < 5000) return(cases) else
    return(cases %>% filter(Meldedatum < MD) %>%
             bind_rows(RKI.cases(AG,MD,MD_bis))
    )
  return(cases)
}


# Funktion zählt die Differenz in Tagen vom jüngsten Meldedatum überhaupt bis
# zum letzten Datum, an dem ein anzugebender Grenzwert überschritten war
# Parameter: Grenz-/Schwellenwert
ok <- function(Grenzwert) {  
  as.numeric((max(timeline$Meldedatum) - max(as.data.frame(timeline[which(timeline$Inzidenz >= Grenzwert),])$Meldedatum)))
}

status <- function(Inzidenz) {cut(Inzidenz,
                                  breaks=c(-Inf,35, 50, 100, 150, 200, Inf),
                                  labels=c("000-035","035-050","050-100","100-150","150-200","200+"))
  
}
```

```{r Datenabruf, eval=TRUE, echo=FALSE}
# RKI-Datenbankzahlen (incl. Nachmeldungen)
cases <- RKI.cases(params$IDKreis, "2020-01-01", Sys.Date()) 

# "Eingefrorene" RKI-Dashboardzahlen (ohne Nachmeldungen, notbremsenrelevant)
url <- "https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Fallzahlen_Kum_Tab.xlsx?__blob=publicationFile"
destfile <- "Fallzahlen_Kum_Tab.xlsx"
curl::curl_download(url, destfile)
```

```{r, Erstelle_Timeline, eval=TRUE, echo=FALSE}
timeline <- cases %>%
  filter(NeuerFall %in% c(1,0)) %>%
  group_by(Meldedatum) %>%
  arrange(Meldedatum) %>%
  summarise_at(c("AnzahlFall"), sum, na.rm = TRUE) %>%
  complete(Meldedatum = seq.Date(min(Meldedatum), today() - 1, by = "day"))

timeline$AnzahlFall <- replace(timeline$AnzahlFall, is.na(timeline$AnzahlFall), 0)

# Rückblickende Summe der Fallzahlen der letzten 7 Tage, von jedem einzelnen
# Datum aus gerechnet, das ganze auf 100.000 Einwohner normalisiert ergibt
# die berüchtigte "7-Tage-je-100.000-Einwohner-Inzidenz"
timeline$Inzidenz <- rollsum(timeline$AnzahlFall, 7,
                             fill = 0,
                             align = "right") * 100000 / EWO

# Höchste Inzidenz der jeweils vorausgehenden 7 Tage, liefert die Aussage, ob
# ein bestimmter Wert in dieser Zeit nicht überschritten wurde
timeline$Inzidenz.max7 <- rollmax(timeline$Inzidenz, 7,
                                  fill = 0,
                                  align = "right"
)
```

```{r, Erstelle_Schwellen, eval=TRUE, echo=FALSE}
Schwellen <- params$limits %>%
  as.data.frame() %>%
  rename(Grenzwert = 1) %>%
  mutate(bei_Fallzahl = floor(Grenzwert * EWO/100000)) 
Schwellen$ok_seit <- sapply(Schwellen$Grenzwert, ok)
# Schwellen$ok_RKI <- sapply(Schwellen$Grenzwert, checkdash)

names(Schwellen) <- c("Grenzwert","max. Fälle","Tag(e)")


```

```{r, Erstelle_Weekly_Plot, eval=TRUE, echo=FALSE}
weekly <- timeline %>%
  mutate(across(3:4, round, 1)) %>% 
  as.data.frame() %>% 
  tail(7) %>% 
  mutate(Inzidenz.1t = round(AnzahlFall/EWO*100000,1)) %>%
  rename(I.1d = 5) %>%
  mutate(cumsum(AnzahlFall)) %>%
  rename(lfd.sum = 6)

weekly.plot <- weekly %>%
  ggplot(aes(x = Meldedatum, y = Inzidenz)) +
  geom_bar(stat = "identity", width = 1, fill = "grey") +
  geom_bar(aes(y = I.1d, x = Meldedatum), stat = "identity") +
  geom_text(aes(label = paste0("", round(Inzidenz,1))), position = position_dodge(width = 0.9), vjust=1.5, size=4) +
  # geom_text(aes(label=paste0("N: ", round(AnzahlFall,1))), position=position_dodge(width=0.9), vjust=4.5) +
  geom_text(aes(y=I.1d, label=paste0(round(AnzahlFall,1))), position=position_dodge(width=0.9), vjust=-1.5) +
  # geom_text(aes(label=paste0("lSum: ",  lfd.sum)), position=position_dodge(width=0.9), vjust=7.5) +
  geom_hline(yintercept=Schwellen[3,1], linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=Schwellen[2,1], linetype="dashed", color = "black", size=1) +
  geom_hline(yintercept=Schwellen[1,1], linetype="dashed", color = "green", size=1) +
  scale_x_date(date_breaks = "1 day", date_labels = "%a, %d.%m") +
  labs(title = paste0(
    "Neu gemeldete Fälle in den letzten 7 Tagen: ",
    sum(weekly$AnzahlFall)
  ))

```


```{r, Erstelle_Delta, eval=TRUE, echo=FALSE}
delta <- cases %>%
  filter(NeuerFall %in% c(1,-1)) %>%
  group_by(Meldedatum, Art = NeuerFall) %>%
  summarize(Fallzahl = sum(AnzahlFall)) %>%
  as.data.frame() %>%
  mutate(Art = c("Storno", "-", "Neu")[Art + 2]) %>%
  mutate(Inzidenzrelevant = c("Nein", "Ja")[((today() - Meldedatum <= 7)) + 1])
delta <- if (!exists("delta")) "Keine neuen Fälle oder Nachmeldungen" else delta

delta.dem <- cases %>%
  filter(NeuerFall %in% c(1,-1)) %>%
  group_by(Meldedatum, Art = NeuerFall, Altersgruppe) %>%
  summarize(Fallzahl = sum(AnzahlFall)) %>%
  as.data.frame() %>%
  mutate(Art = c("Storno", "-", "Neu")[Art + 2]) %>%
  mutate(Inzidenzrelevant = c("Nein", "Ja")[((today() - Meldedatum <= 7)) + 1]) %>%
  pivot_wider(names_from = "Altersgruppe", values_from = "Fallzahl") %>%
  select(sort(names(.))) %>%
  as.data.frame()
delta.dem <- if (!exists("delta.dem")) "Keine neuen Fälle oder Nachmeldungen" else delta.dem


delta.out <- merge(delta,delta.dem)
delta.out[is.na(delta.out)] <- 0

```

```{r, Erstelle_weekdays, eval=TRUE, echo=FALSE}
weekdays <- timeline %>%
  mutate(WD = weekdays(Meldedatum)) %>%
  mutate(DoW = wday(Meldedatum)) %>%
  filter(Meldedatum > max(Meldedatum - backweek * 7)) %>%
  group_by(DoW, WD) %>%
  summarize(Fallzahl_Durchschnitt = round(mean(AnzahlFall), 2), sd = sd(AnzahlFall), .groups = "keep") %>%
  arrange(DoW) %>%
  as.data.frame() %>%
  select(Wochentag = WD, Fallzahl_Durchschnitt, DoW)
```

```{r, Auswertung_Dashboardmeldungen, eval=TRUE, echo=FALSE}
# Auswertung nur der obersten linken Zelle für den Datenstand
# dashdat <- read_excel(destfile,
#                       sheet = 7,
#                       range = "A2",
#                       col_names = FALSE) 
# dash.stand <- as.Date(parse_date_time(substring(dash.inz[1,1], 8, 17), order = "dmy"))

# Abruf der eigentlichen Daten
dash.inz <- read_excel(destfile, sheet=7, skip=4, col_names = FALSE) %>% select(-1) %>% t()  %>% data.frame()

# AdHoc-Funktion für die Umwandlung der bizarren RKI-Datumsangaben
as.excel.date=function(x) as.Date(x,origin='1899-12-30')

# Datum teilweise als Text im Format "TT.MM.JJJJ", teilweise als Charset im 
# Format "#####.00000" angegeben, muss getrennt geparst werden.
# Zielformat: "JJJJ-MM-DD" als date
dash.inz[which(nchar(dash.inz$X1) == 10),]$X1 <- as.Date(parse_date_time(dash.inz[which(nchar(dash.inz$X1) == 10),]$X1, c('d.m.y')))
dash.inz[which(nchar(dash.inz$X1) == 11),]$X1 <- dash.inz[which(nchar(dash.inz$X1) == 11),]$X1 %>% as.numeric() %>% as.excel.date()
# vorübergehendes Zusammenfassen von AGS und Kreisname
colnames(dash.inz) <- paste0(str_pad(dash.inz[2,],5,side=c("left"), pad="0"),"",dash.inz[1,])

# Entsorgen der ersten beiden Zeilen
dash.inz <- dash.inz[-(1:2),]


dash.inz$Datum <- as.Date(as.numeric(dash.inz$`0LKNRLK`))


#Umwandlung breit in lang, Trennung von AGS und Kreis
dash.inz.pivot <- dash.inz %>%
  select(-1) %>%
  pivot_longer(!Datum, 
               names_to = "Kreis",
               values_to = "Inzidenz") %>% 
  mutate(Inzidenz = round(as.numeric(Inzidenz),1)) %>%
  separate(Kreis,c("AGS","Kreis"), sep=5)

dash.inz.pivot$mysize <- rep(0.5, nrow(dash.inz.pivot))
dash.inz.pivot$mysize[dash.inz.pivot$AGS=="09262"] <- 1

dash.inz.plot <- dash.inz.pivot %>% filter(Kreis %in% c("SK Passau",
                                                      "LK Passau",
                                                      "SK Landshut",
                                                      "LK Freyung-Grafenau",
                                                      "LK Rottal-Inn",
                                                      "LK Deggendorf")) %>%
  ggplot(aes(x = Datum, y = Inzidenz, group=Kreis, color=Kreis, size=mysize)) + 
  geom_line() +
scale_size(range = c(0.5, 1), guide="none")



# ... und nochmal das gleiche, nur diesmal für die Fallzahlen
dash.cases <- read_excel(destfile, sheet=6, skip=4, col_names = FALSE) %>% select(-1) %>% t()  %>% data.frame()

# AdHoc-Funktion für die Umwandlung der bizarren RKI-Datumsangaben
as.excel.date=function(x) as.Date(x,origin='1899-12-30')

# Datum teilweise als Text im Format "TT.MM.JJJJ", teilweise als Charset im 
# Format "#####.00000" angegeben, muss getrennt geparst werden.
# Zielformat: "JJJJ-MM-DD" als date
dash.cases[which(nchar(dash.cases$X1) == 10),]$X1 <- as.Date(parse_date_time(dash.cases[which(nchar(dash.cases$X1) == 10),]$X1, c('d.m.y')))
dash.cases[which(nchar(dash.cases$X1) == 11),]$X1 <- dash.cases[which(nchar(dash.cases$X1) == 11),]$X1 %>% as.numeric() %>% as.excel.date()
# vorübergehendes Zusammenfassen von AGS und Kreisname
colnames(dash.cases) <- paste0(str_pad(dash.cases[2,],5,side=c("left"), pad="0"),"",dash.cases[1,])

# Entsorgen der ersten beiden Zeilen
dash.cases <- dash.cases[-(1:2),]


dash.cases$Datum <- as.Date(as.numeric(dash.cases$`0LKNRLK`))


#Umwandlung breit in lang, Trennung von AGS und Kreis
dash.cases.pivot <- dash.cases %>%
  select(-1) %>%
  pivot_longer(!Datum, 
               names_to = "Kreis",
               values_to = "Inzidenz") %>% 
  mutate(Inzidenz = round(as.numeric(Inzidenz),1)) %>%
  separate(Kreis,c("AGS","Kreis"), sep=5)

dash.cases.pivot$mysize <- rep(0.5, nrow(dash.cases.pivot))
dash.cases.pivot$mysize[dash.cases.pivot$AGS=="09262"] <- 1

dash.cases.plot <- dash.cases.pivot %>% filter(Kreis %in% c("SK Passau",
                                                      "LK Passau",
                                                      "SK Landshut",
                                                      "LK Freyung-Grafenau",
                                                      "LK Rottal-Inn",
                                                      "LK Deggendorf")) %>%
  ggplot(aes(x = Datum, y = Inzidenz, group=Kreis, color=Kreis, size=mysize)) + 
  geom_line() +
scale_size(range = c(0.5, 1), guide="none")

```

# Diagramme zur aktuellen Inzidenz

## Column {data-width="650"}

### Inzidenz am `r format(tail(timeline,1)$Meldedatum, "%a, %d.%m.%Y")`

```{r}
gauge(round(tail(timeline,1)$Inzidenz,1), min = 0, max = 150,  gaugeSectors(
  success = c(0, 50), warning = c(50, 100), danger = c(100, 999)
))
```

### 7-Tage-Inzidenz: Übersicht

```{r}
weekly.plot
```

## Column {data-width="350"}

### Entwicklung der Inzidenzen

```{r, Inzidenzplot, eval=TRUE, echo=FALSE}
InzPlot <- timeline %>% 
  ggplot(aes(x=Meldedatum, y=Inzidenz)) +
  geom_col() +
  geom_smooth(method = "gam")
InzPlot

```

### Fälle pro Tag

```{r, CasePlotAll, echo=FALSE}
CasePlot <- cases %>%
  filter(NeuerFall %in% c(0,1)) %>%
  filter(Meldedatum > "2020-01-01") %>%
  group_by(Meldedatum) %>%
  summarise(Fälle = sum(AnzahlFall)) %>%
  # pivot_wider(names_from = Meldedatum, values_from = AnzahlFall) %>%
  as.data.frame() %>%
  ggplot(aes(x = Meldedatum, y = Fälle)) +
    geom_col() + 
    geom_smooth(method = "gam")
CasePlot
```

# Strukturdaten {data-orientation="rows"}

## Details zu Inzidenz und Altersstruktur

### Heute neu

```{r, Delta, eval=TRUE, echo=FALSE}
# print(delta.out, row.names = FALSE)
if(count(delta.out)==0) print("Heute keine neuen Fälle gemeldet") else knitr::kable(delta.out)
```

### Altersstruktur

"Kohorteninzidenz" steht für die getrennt nach Altersgruppen ("Kohorten") ausgewiesene 7-Tage-Inzidenz. Diese wird von RKI bislang nicht veröffentlicht, da hierfür die lokale Altersstruktur bekannt sein muss.

NA = "Not Available", d.h. kein Fall in dieser Altersklasse gemeldet

```{r, Altersstruktur, echo=FALSE}
Altersstruktur <- cases %>%
  filter(NeuerFall %in% c(0,1)) %>%
  filter(Meldedatum > Sys.Date()-8) %>%
  group_by(Altersklasse=Altersgruppe) %>%
  summarise(Fälle = sum(AnzahlFall)) %>%
  merge(Altersklassen, all.y=TRUE) %>%
  mutate(Kohorteninzidenz = round(Fälle/EWO*100000,1)) %>%
  # select(-3)  %>%
  t() %>%
  as.data.frame()


names(Altersstruktur) <- Altersstruktur[1,] 
knitr::kable(Altersstruktur[2:4,], align = c("c","c","c"))



```

## Row

### Top Ten in Deutschland

```{r, TopTenBRD, eval=TRUE, echo=FALSE}
TopTenBRD <-dash.inz.pivot %>%
  filter(Datum == max(dash.inz.pivot$Datum)) %>%
  select(Kreis, Inzidenz) %>%
  arrange(Inzidenz) %>%
  head(10)
kable(TopTenBRD, align="lr", format = "html", table.attr = "style='width:50%;'")
# print(Schwellen, row.names = FALSE)
```

### Top Ten in Bayern

```{r, TopTenBayrn, eval=TRUE, echo=FALSE}
TopTenBayern <-dash.inz.pivot %>%
  filter(Datum == max(dash.inz.pivot$Datum)) %>%
  filter(grepl("09...", AGS)) %>%
  select(Kreis, Inzidenz) %>%
  arrange(Inzidenz) %>%
  head(10)
kable(TopTenBayern, align="lr", format = "html", table.attr = "style='width:50%;'")
# print(Schwellen, row.names = FALSE)
```




# Ausblick auf die nächsten 7 Tage

------------------------------------------------------------------------

## Blick in die Kristallkugel {.tabset}

### Prognose der Fallzahlen

```{r, Prognoseberechnung, eval=TRUE, echo=FALSE}
two.week <- weekly %>% 
  complete(Meldedatum=seq.Date(min(Meldedatum), 
                               max(Meldedatum) + 7,
                               by="day"))
two.week[8:14,2] <- -two.week[1:7,2]
prognosis <- two.week %>%
  mutate(Anzahl.Fall.ext = ifelse(is.na(AnzahlFall), -AnzahlFall, AnzahlFall), DoW=wday(Meldedatum)) %>%
  mutate(lfd.sum = cumsum(AnzahlFall)) %>%
  full_join(weekdays,by="DoW") %>%
  tail(8) %>%
  select(Inzidenz,Meldedatum,AnzahlFall,Fallzahl_Durchschnitt) %>%
  mutate(var0 = AnzahlFall,
         var1 = (AnzahlFall+Fallzahl_Durchschnitt),
         var2 = (AnzahlFall+2*Fallzahl_Durchschnitt))
prognosis[1,4:7] <- two.week[7,6]
prognosis <- prognosis %>%
  select(Meldedatum,var0,var1,var2, AnzahlFall) %>%
  mutate(sum0 = cumsum(var0),
         sum1 = cumsum(var1),
         sum2 = cumsum(var2)) %>%
  mutate(Inz0 = sum0/EWO*100000,
         Inz1 = sum1/EWO*100000,
         Inz2 = sum2/EWO*100000)  %>%
  mutate(DT = Meldedatum+1)
```


```{r, ProgPlotFall, eval=TRUE, echo=FALSE}
prog.case.plot <- prognosis %>%
  ggplot(aes(x=DT)) +
  geom_line(aes(y=sum0), color="green", size=1) +
  geom_line(aes(y=sum1), size=1) +
  geom_line(aes(y=sum2), size=1, color="red") +
  geom_hline(yintercept=Schwellen[3,2], linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=Schwellen[2,2], linetype="dashed", color = "black", size=1) +
  geom_hline(yintercept=Schwellen[1,2], linetype="dashed", color = "green", size=1) +
  geom_text(aes(y=sum0, label=paste0(round(sum0,0))), position=position_dodge(width=0.9), vjust=0.7) +
  geom_text(aes(y=sum1, label=paste0(round(sum1,0))), position=position_dodge(width=0.9), vjust=-0.7) +
  geom_text(aes(y=sum2, label=paste0(round(sum2,0))), position=position_dodge(width=0.9), vjust=-2.1) +
  scale_x_date(date_breaks = "1 day", date_labels = "%a, %d.%m.") +
  geom_text(aes(y=-10, x=DT), label=c("DT",
                                              "DT+1",
                                              "DT+2",
                                              "DT+3",
                                              "DT+4",
                                              "DT+5",
                                              "DT+6",
                                              "DT+7")) +
  labs(title=paste0("Absehbare FALLZAHLEN-Prognose")) +
  scale_color_discrete(name ="Legende", labels = c("Var0","Var1","Var2")) +
  ylab("Fallzahlen") + ylim(-10, (floor(max(prognosis$sum2)/25)+2)*25) +
  xlab("Veröffentlichungsdatum (1 Tag nach Meldedatum)") +
  geom_text(data=tail(prognosis,7), aes(y=sum0, label=paste0("(",AnzahlFall,")",'\U279E')), position=position_dodge(width=0.9), hjust=1.5, vjust=0.7) 
  
prog.case.plot
```

### Prognose der Inzidenzen

```{r, ProgPlotInz, eval=TRUE, echo=FALSE}
prog.plot <- prognosis %>%
  ggplot(aes(x=DT)) +
  geom_line(aes(y=Inz0), color="green", size=1) +
  geom_line(aes(y=Inz1), size=1) +
  geom_line(aes(y=Inz2), size=1, color="red") +
  geom_hline(yintercept=Schwellen[3,1], linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=Schwellen[2,1], linetype="dashed", color = "black", size=1) +
  geom_hline(yintercept=Schwellen[1,1], linetype="dashed", color = "green", size=1) +
  geom_text(aes(y=Inz0, label=paste0(round(Inz0,1))), position=position_dodge(width=0.9), vjust=0.7) +
  geom_text(aes(y=Inz1, label=paste0(round(Inz1,1))), position=position_dodge(width=0.9), vjust=-0.7) +
  geom_text(aes(y=Inz2, label=paste0(round(Inz2,1))), position=position_dodge(width=0.9), vjust=-2.1) +
  scale_x_date(date_breaks = "1 day", date_labels = "%a, %d.%m.") +
  geom_text(aes(y=-10, x=DT), label=c("DT",
                                              "DT+1",
                                              "DT+2",
                                              "DT+3",
                                              "DT+4",
                                              "DT+5",
                                              "DT+6",
                                              "DT+7")) +
  labs(title=paste0("Absehbare INZIDENZ-Prognose ")) +
  scale_color_discrete(name ="Legende", labels = c("Var0","Var1","Var2")) +
  ylab("7-Tage-Inzidenz") + ylim(-10, (floor(max(prognosis$Inz2)/25)+2)*25) +
  xlab("Veröffentlichungsdatum (1 Tag nach Meldedatum)") 
prog.plot
```


## Datenbasis für die Prognosen

Fallzahlen gehen je nach Wochentag in unterschiedlicher Höhe ein. Basierend auf den letzten `r backweek` Wochen bzw. `r backweek*7` Tagen ergibt sich folgende Verteilung:

### Fallzahlendurchschnitt je Wochentag

```{r, Weekdays, eval=TRUE, echo=FALSE}
weekdays %>%
  mutate(Mittelwert = Fallzahl_Durchschnitt) %>%
  arrange(DoW) %>%
  select(1,4) %>%
  kable(format = "html", table.attr = "style='width:80%;'")
  # print(row.names = FALSE)
```

# Inzidenzabhängige Öffnungsregelungen {data-orientation="columns"}

```{r eval=TRUE, echo=FALSE}
url <- "https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Fallzahlen_Kum_Tab.xlsx?__blob=publicationFile"


dash.rki.data <- rio::import(file = url,which = 7)[-(1:4),] %>%
  rename(Kreis=2) %>%
  filter(Kreis=="SK Passau") %>%
  t() %>%
  as.data.frame 
# dash.rki.stand <- row.names(dash.rki.data)[1]
dash.rki.stand <- as.Date(parse_date_time(substring(row.names(dash.rki.data)[1], 8, 17), order="dmy"))

dash.rki.data <- as.data.frame(dash.rki.data[-(1:3),]) %>% rename(Dashboard.Inzidenz=1)
dash.rki.data$Dashboard.Inzidenz <- round(as.numeric(dash.rki.data$Dashboard.Inzidenz),1)
dash.rki.data$Datum <- dash.rki.stand - max(row(dash.rki.data)) + row(dash.rki.data)

anhang <- timeline %>% tail(1) %>% select(Dashboard.Inzidenz=Inzidenz, Datum=Meldedatum)

dash.aktuell <- (tail(timeline,1)$Meldedatum == tail(dash.rki.data,1)$Datum)[1,1]

if (tail(timeline,1)$Meldedatum == tail(dash.rki.data,1)$Datum) {
  anhang$Datum <- anhang$Datum + 1
  anhang$Dashboard.Inzidenz <- round(anhang$Dashboard.Inzidenz,1)
  dash.rki.data <- rbind(dash.rki.data, anhang)
  dash.rki.data$Datum <- as.Date((dash.rki.data$Datum))
  dash.rki.stand <- dash.rki.stand + 1
} 


```

## Column {data-width="650"}

### Unterschreitung von Schwellenwerten {data-height="200"}

Grenzwerte müssen "dauerhaft" unter- bzw. überschritten sein, bevor die damit verbundenen Regelungen greifen. Das gilt im allgemeinen ab dem dritten Tag der Über-/Unterschreitung als der Fall.

Bei den 7-Tage-Inzidenzen für frühere Tage muss berücksichtigt werden, dass es sich hier um die jeweils an dem angegebenen Tag berichteten Werte handelt, die **nicht** durch an Folgetagen nachübermittelte Fälle aktualisiert werden (für den Berichtstag "eingefrorene" Werte). RKI stellt diese eingefrorenen Werte einschließlich einer mehrmonatigen Rückschau täglich zur Verfügung.

Der hier verwendeten Zahlen geben den Meldestand von `r format(as.Date(dash.rki.stand), "%A, %d.%m.%Y")` wieder.

### Vergleich mit den Nachbarn

```{r, Nachbarvergleich, eval=TRUE, echo=FALSE}
timeline.plot <- dash.inz.pivot %>%
  # filter(grepl("0926.", AGS)) %>%
  filter(Kreis %in% c("SK Passau",
                      "LK Passau",
                      "LK Freyung-Grafenau",
                      "LK Deggendorf",
                      "LK Rottal-Inn")) %>%
  filter(Datum >= "2021-01-01") %>%
  plot_ly(x=~Datum, y=~Inzidenz, type='scatter', color=~Kreis, mode='lines')
timeline.plot
```

## Column {data-width="350"}

### Grenzwert 35 unterschritten seit

```{r}
gauge(as.numeric(dash.rki.stand - max(dash.rki.data[which(dash.rki.data$Dashboard.Inzidenz >= 35),]$Datum)),
      min = 0,
      max = 10,
      symbol = ' T',
      gaugeSectors(success = c(3, 999),
                   warning = c(1, 3),
                   danger = c(0, 0)
))
```

### Grenzwert 50 unterschritten seit

```{r}
gauge(as.numeric(dash.rki.stand - max(dash.rki.data[which(dash.rki.data$Dashboard.Inzidenz >= 50),]$Datum)),
      min = 0,
      max = 10,
      symbol = ' T',
      gaugeSectors(success = c(3, 999),
                   warning = c(1, 3),
                   danger = c(0, 0)
))
```

### Grenzwert 100 unterschritten seit

```{r}
gauge(as.numeric(dash.rki.stand - max(dash.rki.data[which(dash.rki.data$Dashboard.Inzidenz >= 100),]$Datum)),
      min = 0,
      max = 10,
      symbol = ' T',
      gaugeSectors(success = c(3, 999),
                   warning = c(1, 3),
                   danger = c(0, 0)
))
```

### Grenzwert 150 unterschritten seit

```{r}
gauge(as.numeric(dash.rki.stand - max(dash.rki.data[which(dash.rki.data$Dashboard.Inzidenz >= 150),]$Datum)),
      min = 0,
      max = 10,
      symbol = ' T',
      gaugeSectors(success = c(3, 999),
                   warning = c(1, 3),
                   danger = c(0, 0)
))
```
